<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="

  Rescale Bucket
  #

Since the number of total buckets dramatically influences the performance, Paimon allows users to
tune bucket numbers by ALTER TABLE command and reorganize data layout by INSERT OVERWRITE
without recreating the table/partition. When executing overwrite jobs, the framework will automatically
scan the data with the old bucket number and hash the record according to the current bucket number.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://example.org/maintenance/rescale-bucket/">
  <meta property="og:site_name" content="Apache Paimon">
  <meta property="og:title" content="Rescale Bucket">
  <meta property="og:description" content="Rescale Bucket#Since the number of total buckets dramatically influences the performance, Paimon allows users to tune bucket numbers by ALTER TABLE command and reorganize data layout by INSERT OVERWRITE without recreating the table/partition. When executing overwrite jobs, the framework will automatically scan the data with the old bucket number and hash the record according to the current bucket number.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="maintenance">
<title>Rescale Bucket | Apache Paimon</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://example.org/maintenance/rescale-bucket/">
<link rel="stylesheet" href="/book.min.d5e59cb0aa8d22a5813c62cd5e25d3d172489a369c61dc3f622ee96ae1ebb457.css" integrity="sha256-1eWcsKqNIqWBPGLNXiXT0XJImjacYdw/Yi7pauHrtFc=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.ed8e866478944a5c9bf1b56d57e841c7fe2748afd65915a6f729dd332db70f7b.js" integrity="sha256-7Y6GZHiUSlyb8bVtV&#43;hBx/4nSK/WWRWm9yndMy23D3s=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Apache Paimon</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0f577c58e9b3dd44e41e0b83e7c5f9ef" class="toggle"  />
    <label for="section-0f577c58e9b3dd44e41e0b83e7c5f9ef" class="flex">
      <a href="/concepts/" class="flex-auto ">Concepts</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/concepts/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/basic-concepts/" class="">Basic Concepts</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/concurrency-control/" class="">Concurrency Control</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/catalog/" class="">Catalog</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-120b07edbd4c34f9ca14c990e6d3a5c1" class="toggle"  />
    <label for="section-120b07edbd4c34f9ca14c990e6d3a5c1" class="flex">
      <a href="/concepts/rest/" class="flex-auto ">RESTCatalog</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/concepts/rest/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/rest/bear/" class="">Bear Token</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/rest/dlf/" class="">DLF Token</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/rest/rest-api/" class="">REST API</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/table-types/" class="">Table Types</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/system-tables/" class="">System Tables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/data-types/" class="">Data Types</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c7a94b41156194ecee1e09c684d748e5" class="toggle"  />
    <label for="section-c7a94b41156194ecee1e09c684d748e5" class="flex">
      <a href="/concepts/spec/" class="flex-auto ">Specification</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/schema/" class="">Schema</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/snapshot/" class="">Snapshot</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/manifest/" class="">Manifest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/datafile/" class="">DataFile</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/tableindex/" class="">Table Index</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/concepts/spec/fileindex/" class="">File Index</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c0d9adbd958aa78e9b5cb0511c6abe1b" class="toggle"  />
    <label for="section-c0d9adbd958aa78e9b5cb0511c6abe1b" class="flex">
      <a href="/primary-key-table/" class="flex-auto ">Table with PK</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/data-distribution/" class="">Data Distribution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/table-mode/" class="">Table Mode</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-04d66c05043a350c14fa1d446df94a79" class="toggle"  />
    <label for="section-04d66c05043a350c14fa1d446df94a79" class="flex">
      <a href="/primary-key-table/merge-engine/" class="flex-auto ">Merge Engine</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/merge-engine/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/merge-engine/partial-update/" class="">Partial Update</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/merge-engine/aggregation/" class="">Aggregation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/merge-engine/first-row/" class="">First Row</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/changelog-producer/" class="">Changelog Producer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/sequence-rowkind/" class="">Sequence &amp; Rowkind</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/compaction/" class="">Compaction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/primary-key-table/query-performance/" class="">Query Performance</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-7c7495e5c54b216316cbd6cefc4966a1" class="toggle"  />
    <label for="section-7c7495e5c54b216316cbd6cefc4966a1" class="flex">
      <a href="/append-table/" class="flex-auto ">Table w/o PK</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/append-table/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/append-table/streaming/" class="">Streaming</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/append-table/query-performance/" class="">Query Performance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/append-table/update/" class="">Update</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/append-table/bucketed/" class="">Bucketed</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2bc2280284fce30dc9cfe001c4d4f308" class="toggle"  />
    <label for="section-2bc2280284fce30dc9cfe001c4d4f308" class="flex">
      <a href="/flink/" class="flex-auto ">Engine Flink</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/flink/quick-start/" class="">Quick Start</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/sql-ddl/" class="">SQL DDL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/sql-write/" class="">SQL Write</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/sql-query/" class="">SQL Query</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/consumer-id/" class="">Consumer ID</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/sql-lookup/" class="">SQL Lookup</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/sql-alter/" class="">SQL Alter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/clone-tables/" class="">Clone Tables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/procedures/" class="">Procedures</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/action-jars/" class="">Action Jars</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/flink/savepoint/" class="">Savepoint</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-11bc7fef43a73cd8f67282a4f805f959" class="toggle"  />
    <label for="section-11bc7fef43a73cd8f67282a4f805f959" class="flex">
      <a href="/spark/" class="flex-auto ">Engine Spark</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/spark/quick-start/" class="">Quick Start</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/sql-ddl/" class="">SQL DDL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/sql-functions/" class="">SQL Functions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/sql-write/" class="">SQL Write</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/sql-query/" class="">SQL Query</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/sql-alter/" class="">SQL Alter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/auxiliary/" class="">Auxiliary</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/spark/procedures/" class="">Procedures</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c279f1a47f0df5c590de69874c1f87c3" class="toggle"  />
    <label for="section-c279f1a47f0df5c590de69874c1f87c3" class="flex">
      <a href="/ecosystem/" class="flex-auto ">Ecosystem</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/starrocks/" class="">StarRocks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/doris/" class="">Doris</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/hive/" class="">Hive</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/trino/" class="">Trino</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/ecosystem/amoro/" class="">Amoro</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e8c1a2c4fbac828568029fe095ebb072" class="toggle"  />
    <label for="section-e8c1a2c4fbac828568029fe095ebb072" class="flex">
      <a href="/cdc-ingestion/" class="flex-auto ">CDC Ingestion</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/mysql-cdc/" class="">Mysql CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/postgres-cdc/" class="">Postgres CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/kafka-cdc/" class="">Kafka CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/mongo-cdc/" class="">Mongo CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/pulsar-cdc/" class="">Pulsar CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/cdc-ingestion/debezium-bson/" class="">Debezium BSON</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8745d48ca93ee7946abd46b8e0d32417" class="toggle" checked />
    <label for="section-8745d48ca93ee7946abd46b8e0d32417" class="flex">
      <a href="/maintenance/" class="flex-auto ">Maintenance</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/maintenance/filesystems/" class="">Filesystems</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/write-performance/" class="">Write Performance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/dedicated-compaction/" class="">Dedicated Compaction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/manage-snapshots/" class="">Manage Snapshots</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/rescale-bucket/" class="active">Rescale Bucket</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/manage-tags/" class="">Manage Tags</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/metrics/" class="">Metrics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/manage-privileges/" class="">Manage Privileges</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/manage-branches/" class="">Manage Branches</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/manage-partitions/" class="">Manage Partitions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/maintenance/configurations/" class="">Configurations</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-855b9d3470d29baa3d9ac155f1cbb17e" class="toggle"  />
    <label for="section-855b9d3470d29baa3d9ac155f1cbb17e" class="flex">
      <a href="/program-api/" class="flex-auto ">Program API</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/program-api/flink-api/" class="">Flink API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/program-api/java-api/" class="">Java API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/program-api/catalog-api/" class="">Catalog API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/program-api/python-api/" class="">Python API</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0ffde0363b026afda7ad294c5d18c71a" class="toggle"  />
    <label for="section-0ffde0363b026afda7ad294c5d18c71a" class="flex">
      <a href="/migration/" class="flex-auto ">Migration</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/migration/migration-from-hive/" class="">Migration From Hive</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/migration/migration-from-iceberg/" class="">Migration From Iceberg</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/migration/upsert-to-partitioned/" class="">Upsert To Partitioned</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/migration/iceberg-compatibility/" class="">Iceberg Compatibility</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-85fae8232c6bd11576e7262da56e3922" class="toggle"  />
    <label for="section-85fae8232c6bd11576e7262da56e3922" class="flex">
      <a href="/project/" class="flex-auto ">Project</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/project/roadmap/" class="">Roadmap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/project/download/" class="">Download</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/project/contributing/" class="">Contributing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/project/committer/" class="">Committer</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-263d088534eb62bb6fabbdb4626879a6" class="toggle"  />
    <label for="section-263d088534eb62bb6fabbdb4626879a6" class="flex">
      <a href="/learn-paimon/" class="flex-auto ">Learn Paimon</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/learn-paimon/understand-files/" class="">Understand Files</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Rescale Bucket</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#rescale-overwrite">Rescale Overwrite</a></li>
    <li><a href="#use-case">Use Case</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<h1 id="rescale-bucket">
  Rescale Bucket
  <a class="anchor" href="#rescale-bucket">#</a>
</h1>
<p>Since the number of total buckets dramatically influences the performance, Paimon allows users to
tune bucket numbers by <code>ALTER TABLE</code> command and reorganize data layout by <code>INSERT OVERWRITE</code>
without recreating the table/partition. When executing overwrite jobs, the framework will automatically
scan the data with the old bucket number and hash the record according to the current bucket number.</p>
<h2 id="rescale-overwrite">
  Rescale Overwrite
  <a class="anchor" href="#rescale-overwrite">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- rescale number of total buckets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> table_identifier <span style="color:#66d9ef">SET</span> (<span style="color:#e6db74">&#39;bucket&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- reorganize data layout of table/partition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> OVERWRITE table_identifier [PARTITION (part_spec)]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> ... 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> table_identifier
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">WHERE</span> part_spec];
</span></span></code></pre></div><p>Please note that</p>
<ul>
<li><code>ALTER TABLE</code> only modifies the table&rsquo;s metadata and will <strong>NOT</strong> reorganize or reformat existing data.
Reorganize existing data must be achieved by <code>INSERT OVERWRITE</code>.</li>
<li>Rescale bucket number does not influence the read and running write jobs.</li>
<li>Once the bucket number is changed, any newly scheduled <code>INSERT INTO</code> jobs which write to without-reorganized
existing table/partition will throw a <code>TableException</code> with message like
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Try to write table/partition ... with a new bucket num ..., 
</span></span><span style="display:flex;"><span>but the previous bucket num is ... Please switch to batch mode, 
</span></span><span style="display:flex;"><span>and perform INSERT OVERWRITE to rescale current data layout first.
</span></span></code></pre></div></li>
<li>For partitioned table, it is possible to have different bucket number for different partitions. <em>E.g.</em>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> my_table <span style="color:#66d9ef">SET</span> (<span style="color:#e6db74">&#39;bucket&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> OVERWRITE my_table PARTITION (dt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2022-01-01&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> ...;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> my_table <span style="color:#66d9ef">SET</span> (<span style="color:#e6db74">&#39;bucket&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;8&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> OVERWRITE my_table PARTITION (dt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2022-01-02&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> ...;
</span></span></code></pre></div></li>
<li>During overwrite period, make sure there are no other jobs writing the same table/partition.</li>
</ul>
<blockquote class="book-hint info">
  
__Note:__ For the table which enables log system(*e.g.* Kafka), please rescale the topic's partition as well to keep consistency.

</blockquote>

<h2 id="use-case">
  Use Case
  <a class="anchor" href="#use-case">#</a>
</h2>
<p>Rescale bucket helps to handle sudden spikes in throughput. Suppose there is a daily streaming ETL task to sync transaction data. The table&rsquo;s DDL and pipeline
are listed as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- table DDL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> verified_orders (
</span></span><span style="display:flex;"><span>    trade_order_id BIGINT,
</span></span><span style="display:flex;"><span>    item_id BIGINT,
</span></span><span style="display:flex;"><span>    item_price DOUBLE,
</span></span><span style="display:flex;"><span>    dt STRING,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (dt, trade_order_id, item_id) <span style="color:#66d9ef">NOT</span> ENFORCED 
</span></span><span style="display:flex;"><span>) PARTITIONED <span style="color:#66d9ef">BY</span> (dt)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WITH</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;bucket&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;16&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- like from a kafka table 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">temporary</span> <span style="color:#66d9ef">TABLE</span> raw_orders(
</span></span><span style="display:flex;"><span>    trade_order_id BIGINT,
</span></span><span style="display:flex;"><span>    item_id BIGINT,
</span></span><span style="display:flex;"><span>    item_price BIGINT,
</span></span><span style="display:flex;"><span>    gmt_create STRING,
</span></span><span style="display:flex;"><span>    order_status STRING
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">WITH</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;connector&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;kafka&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;topic&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;properties.bootstrap.servers&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;format&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;csv&#39;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- streaming insert as bucket num = 16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> verified_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> trade_order_id,
</span></span><span style="display:flex;"><span>       item_id,
</span></span><span style="display:flex;"><span>       item_price,
</span></span><span style="display:flex;"><span>       DATE_FORMAT(gmt_create, <span style="color:#e6db74">&#39;yyyy-MM-dd&#39;</span>) <span style="color:#66d9ef">AS</span> dt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> raw_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> order_status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;verified&#39;</span>;
</span></span></code></pre></div><p>The pipeline has been running well for the past few weeks. However, the data volume has grown fast recently,
and the job&rsquo;s latency keeps increasing. To improve the data freshness, users can</p>
<ul>
<li>Suspend the streaming job with a savepoint ( see
<a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/internals/job_scheduling/">Suspended State</a> and
<a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/deployment/cli/#terminating-a-job">Stopping a Job Gracefully Creating a Final Savepoint</a> )
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./bin/flink stop <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --savepointPath /tmp/flink-savepoints <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      $JOB_ID
</span></span></code></pre></div></li>
<li>Increase the bucket number
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- scaling out
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> verified_orders <span style="color:#66d9ef">SET</span> (<span style="color:#e6db74">&#39;bucket&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;32&#39;</span>);
</span></span></code></pre></div></li>
<li>Switch to the batch mode and overwrite the current partition(s) to which the streaming job is writing
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#e6db74">&#39;execution.runtime-mode&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;batch&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- suppose today is 2022-06-22
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">-- case 1: there is no late event which updates the historical partitions, thus overwrite today&#39;s partition is enough
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> OVERWRITE verified_orders PARTITION (dt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2022-06-22&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> trade_order_id,
</span></span><span style="display:flex;"><span>       item_id,
</span></span><span style="display:flex;"><span>       item_price
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> verified_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> dt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2022-06-22&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- case 2: there are late events updating the historical partitions, but the range does not exceed 3 days
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> OVERWRITE verified_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> trade_order_id,
</span></span><span style="display:flex;"><span>       item_id,
</span></span><span style="display:flex;"><span>       item_price,
</span></span><span style="display:flex;"><span>       dt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> verified_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> dt <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;2022-06-20&#39;</span>, <span style="color:#e6db74">&#39;2022-06-21&#39;</span>, <span style="color:#e6db74">&#39;2022-06-22&#39;</span>);
</span></span></code></pre></div></li>
<li>After overwrite job has finished, switch back to streaming mode. And now, the parallelism can be increased alongside with bucket number to restore the streaming job from the savepoint
( see <a href="https://nightlies.apache.org/flink/flink-docs-stable/docs/dev/table/sqlclient/#start-a-sql-job-from-a-savepoint">Start a SQL Job from a savepoint</a> )
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#e6db74">&#39;execution.runtime-mode&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;streaming&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> <span style="color:#e6db74">&#39;execution.savepoint.path&#39;</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>savepointPath<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> verified_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> trade_order_id,
</span></span><span style="display:flex;"><span>     item_id,
</span></span><span style="display:flex;"><span>     item_price,
</span></span><span style="display:flex;"><span>     DATE_FORMAT(gmt_create, <span style="color:#e6db74">&#39;yyyy-MM-dd&#39;</span>) <span style="color:#66d9ef">AS</span> dt
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> raw_orders
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> order_status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;verified&#39;</span>;
</span></span></code></pre></div></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#rescale-overwrite">Rescale Overwrite</a></li>
    <li><a href="#use-case">Use Case</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












