
<!DOCTYPE html>
<html lang="zh" dir=ZgotmplZ>

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta name="generator" content="Hugo 0.124.1">
  
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="合并 Compaction#随着越来越多的记录写入 LSM 树，排序运行（sorted runs）的数量也会增加。由于查询 LSM 树需要合并所有的排序运行，过多的排序运行会导致查询性能下降，甚至出现内存不足。
为了限制排序运行的数量，我们需要不时将多个排序运行合并成一个更大的排序运行，这个过程称为compaction。
但是，compaction 是一个资源密集型过程，会消耗一定的 CPU 时间和磁盘 IO，过于频繁的compaction反而可能导致写入变慢。这是在查询性能和写入性能之间的权衡。Paimon 当前采用了类似 RocksDB 的compaction策略 universal compaction.
Compaction 解决的问题：
减少 Level 0 文件数量，避免查询性能下降。 通过 changelog-producer 生成 changelog。 为 MOW 模式 生成 deletion vectors。 支持 Snapshot 过期、Tag 过期和分区过期。 限制：
同一个分区只能有一个 compaction 任务在运行，否则会导致冲突，且一方会抛出异常失败。 写入性能几乎总是会受到 compaction 的影响，因此调优非常关键。
异步合并 Asynchronous Compaction#Compaction 本质上是异步的，但如果你希望它完全异步且不阻塞写入操作，以追求最大写入吞吐量，可以让 compaction 过程更缓慢，不急于完成。
你可以为表配置以下策略：
num-sorted-run.stop-trigger = 2147483647 sort-spill-threshold = 10 lookup-wait = false 这项配置会在写入高峰期产生更多文件，并在写入低谷期逐步合并这些文件，从而实现最佳的读取性能
Dedicated compaction job#一般来说，如果你期望多个写入任务同时写同一个表，必须将 compaction 任务单独分离出来。你可以使用以下方式： dedicated compaction job.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="合并 Compaction" />
<meta property="og:description" content="合并 Compaction#随着越来越多的记录写入 LSM 树，排序运行（sorted runs）的数量也会增加。由于查询 LSM 树需要合并所有的排序运行，过多的排序运行会导致查询性能下降，甚至出现内存不足。
为了限制排序运行的数量，我们需要不时将多个排序运行合并成一个更大的排序运行，这个过程称为compaction。
但是，compaction 是一个资源密集型过程，会消耗一定的 CPU 时间和磁盘 IO，过于频繁的compaction反而可能导致写入变慢。这是在查询性能和写入性能之间的权衡。Paimon 当前采用了类似 RocksDB 的compaction策略 universal compaction.
Compaction 解决的问题：
减少 Level 0 文件数量，避免查询性能下降。 通过 changelog-producer 生成 changelog。 为 MOW 模式 生成 deletion vectors。 支持 Snapshot 过期、Tag 过期和分区过期。 限制：
同一个分区只能有一个 compaction 任务在运行，否则会导致冲突，且一方会抛出异常失败。 写入性能几乎总是会受到 compaction 的影响，因此调优非常关键。
异步合并 Asynchronous Compaction#Compaction 本质上是异步的，但如果你希望它完全异步且不阻塞写入操作，以追求最大写入吞吐量，可以让 compaction 过程更缓慢，不急于完成。
你可以为表配置以下策略：
num-sorted-run.stop-trigger = 2147483647 sort-spill-threshold = 10 lookup-wait = false 这项配置会在写入高峰期产生更多文件，并在写入低谷期逐步合并这些文件，从而实现最佳的读取性能
Dedicated compaction job#一般来说，如果你期望多个写入任务同时写同一个表，必须将 compaction 任务单独分离出来。你可以使用以下方式： dedicated compaction job." />
<meta property="og:type" content="article" />
<meta property="og:url" content="//localhost:1313/primary-key-table/compaction/" /><meta property="article:section" content="primary-key-table" />


<title>合并 Compaction | Paimon文档</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="alternate" hreflang="en" href="//localhost:1313/en/primary-key-table/compaction/" title="Compaction">

<link rel="stylesheet" href="/book.min.b952fefba7a2e6dac79b3035a33b021d21a5f84843c9890ad9ab605f3bfe0eac.css" integrity="sha256-uVL&#43;&#43;6ei5trHmzA1ozsCHSGl&#43;EhDyYkK2atgXzv&#43;Dqw=">
<script defer src="/zh.search.min.1092aeece9f3a871211d0360b674964f57ab02c6cf8cace5e841694ede2c9ebc.js" integrity="sha256-EJKu7OnzqHEhHQNgtnSWT1erAsbPjKzl6EFpTt4snrw="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
  

<link rel="stylesheet" type="text/css" href="//localhost:1313//font-awesome/css/font-awesome.min.css">
<script src="//localhost:1313//js/anchor.min.js"></script>
<script src="//localhost:1313//js/flink.js"></script>



  
  <script>
    var _paq = window._paq = window._paq || [];
     
     
    _paq.push(['disableCookies']);
     
    _paq.push(["setDomains", ["*.flink.apache.org","*.nightlies.apache.org/flink"]]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//matomo.privacy.apache.org/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  
</head>

<body dir=ZgotmplZ>
  
    <input type="checkbox" class="hidden toggle" id="menu-control" />
    <input type="checkbox" class="hidden toggle" id="toc-control" />
  
  <main class="container flex">
    
      <aside class="book-menu">
        
  

<nav>


<a id="logo" href="//localhost:1313/">
    <img width="100%" src="//localhost:1313//paimon_black.svg">
</a>
<p style="text-align:right">1.2.0</p>

<div class="book-search">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>










  





  
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-c731eb3eada0765f704948e2d3b9bb48" class="toggle"  />
    <label for="section-c731eb3eada0765f704948e2d3b9bb48" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-book title maindish" aria-hidden="true"></i>&nbsp;&nbsp;概念 Concepts</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/overview/" class="">概述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/basic-concepts/" class="">基础概念 Basic Concepts</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/concurrency-control/" class="">并发控制 Concurrency Control</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/catalog/" class="">Catalog</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-8451cf5dbd0ba165d2eff8eab794a5e2" class="toggle"  />
    <label for="section-8451cf5dbd0ba165d2eff8eab794a5e2" class="flex justify-between">RESTCatalog<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/rest/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/rest/bear/" class="">Bear Token</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/rest/dlf/" class="">DLF Token</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/rest/rest-api/" class="">REST API</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/table-types/" class="">表类型 Table Types</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/system-tables/" class="">系统表 System Tables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/data-types/" class="">数据类型 Data Types</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/functions/" class="">函数 Functions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-04b977f4d78c1a1179624ef9cf1c052f" class="toggle"  />
    <label for="section-04b977f4d78c1a1179624ef9cf1c052f" class="flex justify-between">规范说明 Specification<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/overview/" class="">概述 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/schema/" class="">模式文件 Schema</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/snapshot/" class="">快照文件 Snapshot</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/manifest/" class="">清单文件 Manifest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/datafile/" class="">数据文件 DataFile</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/tableindex/" class="">表索引 Table Index</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/concepts/spec/fileindex/" class="">文件索引 File Index</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-13198e701ffb9c73ec7a3177a4f953f1" class="toggle" checked />
    <label for="section-13198e701ffb9c73ec7a3177a4f953f1" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-database title maindish" aria-hidden="true"></i>&nbsp;&nbsp;主键表 Table with PK</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/overview/" class="">概览 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/data-distribution/" class="">数据分布 Data Distribution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/table-mode/" class="">表模式 Table Mode</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-f845a63b155c9d2fb0db740cc418eb68" class="toggle"  />
    <label for="section-f845a63b155c9d2fb0db740cc418eb68" class="flex justify-between">Merge Engine<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/merge-engine/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/merge-engine/partial-update/" class="">Partial Update</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/merge-engine/aggregation/" class="">Aggregation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/merge-engine/first-row/" class="">First Row</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/changelog-producer/" class="">变化日志生产者 Changelog Producer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/sequence-rowkind/" class="">Sequence 和 Rowkind</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/compaction/" class=" active">合并 Compaction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/primary-key-table/query-performance/" class="">查询性能 Query Performance</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-bb708993c18bd45422a8bcf87778bb93" class="toggle"  />
    <label for="section-bb708993c18bd45422a8bcf87778bb93" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-database title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Table w/o PK</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/append-table/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/append-table/streaming/" class="">Streaming</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/append-table/query-performance/" class="">Query Performance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/append-table/update/" class="">Update</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/append-table/bucketed/" class="">Bucketed</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-23c9b577a4c36b65f28196976e8af8fd" class="toggle"  />
    <label for="section-23c9b577a4c36b65f28196976e8af8fd" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-gear title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Engine Flink</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/quick-start/" class="">Quick Start</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/sql-ddl/" class="">SQL DDL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/sql-write/" class="">SQL Write</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/sql-query/" class="">SQL Query</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/consumer-id/" class="">Consumer ID</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/sql-lookup/" class="">SQL Lookup</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/sql-alter/" class="">SQL Alter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/procedures/" class="">Procedures</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/action-jars/" class="">Action Jars</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/flink/savepoint/" class="">Savepoint</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-86d841c4a4c551bb4e21d460836d4142" class="toggle"  />
    <label for="section-86d841c4a4c551bb4e21d460836d4142" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-gear title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Engine Spark</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/quick-start/" class="">Quick Start</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/sql-ddl/" class="">SQL DDL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/sql-functions/" class="">SQL Functions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/sql-write/" class="">SQL Write</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/sql-query/" class="">SQL Query</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/sql-alter/" class="">SQL Alter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/auxiliary/" class="">Auxiliary</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/spark/procedures/" class="">Procedures</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-30d29cf6aaa7fb1e0e056430337d3cd8" class="toggle"  />
    <label for="section-30d29cf6aaa7fb1e0e056430337d3cd8" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-gear title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Ecosystem</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/starrocks/" class="">StarRocks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/doris/" class="">Doris</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/hive/" class="">Hive</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/trino/" class="">Trino</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/ecosystem/amoro/" class="">Amoro</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-0d8ed5dd97c2657084dd792a5fb3dc39" class="toggle"  />
    <label for="section-0d8ed5dd97c2657084dd792a5fb3dc39" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-gear title maindish" aria-hidden="true"></i>&nbsp;&nbsp;CDC Ingestion</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/mysql-cdc/" class="">Mysql CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/postgres-cdc/" class="">Postgres CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/kafka-cdc/" class="">Kafka CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/mongo-cdc/" class="">Mongo CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/pulsar-cdc/" class="">Pulsar CDC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/cdc-ingestion/debezium-bson/" class="">Debezium BSON</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-572d5eb93948a39233efdc1aa454d415" class="toggle"  />
    <label for="section-572d5eb93948a39233efdc1aa454d415" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-wrench title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Maintenance</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/filesystems/" class="">Filesystems</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/write-performance/" class="">Write Performance</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/dedicated-compaction/" class="">Dedicated Compaction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/manage-snapshots/" class="">Manage Snapshots</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/rescale-bucket/" class="">Rescale Bucket</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/manage-tags/" class="">Manage Tags</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/metrics/" class="">Metrics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/manage-privileges/" class="">Manage Privileges</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/manage-branches/" class="">Manage Branches</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/manage-partitions/" class="">Manage Partitions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/maintenance/configurations/" class="">Configurations</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-ffda0ff45a34e5f3ed8bf3826a7c8879" class="toggle"  />
    <label for="section-ffda0ff45a34e5f3ed8bf3826a7c8879" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-briefcase title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Program API</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/program-api/rest-api/" class="">REST API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/program-api/flink-api/" class="">Flink API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/program-api/java-api/" class="">Java API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/program-api/catalog-api/" class="">Catalog API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/program-api/python-api/" class="">Python API</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-3f8a436f48e29eeb422e6dd0a6e20e71" class="toggle"  />
    <label for="section-3f8a436f48e29eeb422e6dd0a6e20e71" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-briefcase title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Migration</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/migration/migration-from-hive/" class="">Migration From Hive</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/migration/migration-from-iceberg/" class="">Migration From Iceberg</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/migration/upsert-to-partitioned/" class="">Upsert To Partitioned</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/migration/clone-to-paimon/" class="">Clone To Paimon</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-3882ebcb06158ef11bac6340af15617a" class="toggle"  />
    <label for="section-3882ebcb06158ef11bac6340af15617a" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-briefcase title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Iceberg Metadata</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/append-table/" class="">Append Table</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/primary-key-table/" class="">Primary Key Table</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/iceberg-tags/" class="">Iceberg Tags</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/hive-catalog/" class="">Hive Catalogs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/ecosystem/" class="">Ecosystem</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/iceberg/configurations/" class="">Configurations</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  	<br/>
  
  
    <input type="checkbox" id="section-fd0d6ee095aef42da7d15863a92a4aa0" class="toggle"  />
    <label for="section-fd0d6ee095aef42da7d15863a92a4aa0" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-sitemap title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Project</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/project/roadmap/" class="">Roadmap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/project/download/" class="">Download</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/project/contributing/" class="">Contributing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/project/committer/" class="">Committer</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-9e09a206f89e5011227bdf8d37b7ee20" class="toggle"  />
    <label for="section-9e09a206f89e5011227bdf8d37b7ee20" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-sitemap title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Learn Paimon</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost:1313/learn-paimon/understand-files/" class="">Understand Files</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>
















<br/>
<hr class="menu-break">

<a href="//paimon.apache.org" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> Project Homepage</a>
<br/>

<a href="//paimon.apache.org/docs/master/api/java/" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> JavaDocs</a>
<br/>

<hr class="menu-break">
<li style="list-style-type: none">
  <br>
  <input type="checkbox" id="section-version-picker" class="toggle">
  <label for="section-version-picker" class="flex justify-between">
     <div style="font-weight:450;margin-bottom:0.5em">Pick Docs Version</div>
     <span>▾</span>
  </label>
  <ul>
    <a href="//localhost:1313/">
      1.2 (✓)
    </a>
    <hr class="menu-break">
    
      <li>
        <a href="https://paimon.apache.org/docs/master">
          master
        </a>
      </li>
    
      <li>
        <a href="https://paimon.apache.org/docs/1.2">
          stable
        </a>
      </li>
    
      <li>
        <a href="https://paimon.apache.org/docs/1.2">
          1.2
        </a>
      </li>
    
      <li>
        <a href="https://paimon.apache.org/docs/1.1">
          1.1
        </a>
      </li>
    
      <li>
        <a href="https://paimon.apache.org/docs/1.0">
          1.0
        </a>
      </li>
    
    <hr class="menu-break">
    <li>
      <a href="//localhost:1313//versions">
          All Versions
      </a>
    </li>
  </ul>
</li>




  

  


  





<a  href="//localhost:1313/en/primary-key-table/compaction/" class="flex align-center">
  <i class="fa fa-globe" aria-hidden="true"></i>&nbsp;&nbsp;
  English
</a>



</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </aside>
    

    <div class="book-page">
      
        <header class="book-header">
          
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>合并 Compaction</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  

<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#异步合并-asynchronous-compaction">异步合并 Asynchronous Compaction</a></li>
    <li><a href="#dedicated-compaction-job">Dedicated compaction job</a></li>
    <li><a href="#record-level-expire">Record-Level expire</a></li>
    <li><a href="#full-compaction">Full Compaction</a></li>
    <li><a href="#lookup-compaction">Lookup Compaction</a></li>
    <li><a href="#compaction-options">Compaction Options</a>
      <ul>
        <li><a href="#number-of-sorted-runs-to-pause-writing">Number of Sorted Runs to Pause Writing</a></li>
        <li><a href="#number-of-sorted-runs-to-trigger-compaction">Number of Sorted Runs to Trigger Compaction</a></li>
      </ul>
    </li>
  </ul>
</nav>


  </aside>
  
 
        </header>
      

      






      
  <article class="markdown"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<h1 id="合并-compaction">
  合并 Compaction
  <a class="anchor" href="#%e5%90%88%e5%b9%b6-compaction">#</a>
</h1>
<p>随着越来越多的记录写入 LSM 树，排序运行（sorted runs）的数量也会增加。由于查询 LSM 树需要合并所有的排序运行，过多的排序运行会导致查询性能下降，甚至出现内存不足。</p>
<p>为了限制排序运行的数量，我们需要不时将多个排序运行合并成一个更大的排序运行，这个过程称为compaction。</p>
<p>但是，compaction 是一个资源密集型过程，会消耗一定的 CPU 时间和磁盘 IO，过于频繁的compaction反而可能导致写入变慢。这是在查询性能和写入性能之间的权衡。Paimon 当前采用了类似 RocksDB 的compaction策略 <a href="https://github.com/facebook/rocksdb/wiki/Universal-Compaction">universal compaction</a>.</p>
<p>Compaction 解决的问题：</p>
<ol>
<li>减少 Level 0 文件数量，避免查询性能下降。</li>
<li>通过 <a href="//localhost:1313/primary-key-table/changelog-producer/">changelog-producer</a> 生成 changelog。</li>
<li>为 <a href="//localhost:1313/primary-key-table/table-mode/#merge-on-write">MOW 模式</a> 生成 deletion vectors。</li>
<li>支持 Snapshot 过期、Tag 过期和分区过期。</li>
</ol>
<p>限制：</p>
<ul>
<li>同一个分区只能有一个 compaction 任务在运行，否则会导致冲突，且一方会抛出异常失败。</li>
</ul>
<p>写入性能几乎总是会受到 compaction 的影响，因此调优非常关键。</p>
<h2 id="异步合并-asynchronous-compaction">
  异步合并 Asynchronous Compaction
  <a class="anchor" href="#%e5%bc%82%e6%ad%a5%e5%90%88%e5%b9%b6-asynchronous-compaction">#</a>
</h2>
<p>Compaction 本质上是异步的，但如果你希望它完全异步且不阻塞写入操作，以追求最大写入吞吐量，可以让 compaction 过程更缓慢，不急于完成。</p>
<p>你可以为表配置以下策略：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">num-sorted-run.stop-trigger <span class="o">=</span> <span class="m">2147483647</span>
</span></span><span class="line"><span class="cl">sort-spill-threshold <span class="o">=</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl">lookup-wait <span class="o">=</span> <span class="nb">false</span>
</span></span></code></pre></div><p>这项配置会在写入高峰期产生更多文件，并在写入低谷期逐步合并这些文件，从而实现最佳的读取性能</p>
<h2 id="dedicated-compaction-job">
  Dedicated compaction job
  <a class="anchor" href="#dedicated-compaction-job">#</a>
</h2>
<p>一般来说，如果你期望多个写入任务同时写同一个表，必须将 compaction 任务单独分离出来。你可以使用以下方式： <a href="//localhost:1313/maintenance/dedicated-compaction/#dedicated-compaction-job">dedicated compaction job</a>.</p>
<h2 id="record-level-expire">
  Record-Level expire
  <a class="anchor" href="#record-level-expire">#</a>
</h2>
<p>在 compaction 中，你可以配置记录级别的过期时间来过期记录，你需要配置：</p>
<ol>
<li><code>'record-level.expire-time'</code>：记录的保留时间。</li>
<li><code>'record-level.time-field'</code>：记录级别过期的时间字段。</li>
</ol>
<p>过期操作发生在 compaction 中，并不能强保证记录能准时过期。
你可以手动触发一次全量 compaction 来过期那些未能及时过期的记录。</p>
<h2 id="full-compaction">
  Full Compaction
  <a class="anchor" href="#full-compaction">#</a>
</h2>
<p>Paimon Compaction 使用了 <a href="https://github.com/facebook/rocksdb/wiki/Universal-Compaction">Universal-Compaction</a>。
默认情况下，当增量数据过多时，会自动执行 Full Compaction，通常你不必过多担心它。</p>
<p>Paimon 还提供了配置，可以定期执行 Full Compaction。</p>
<ol>
<li><code>'compaction.optimization-interval'</code>：表示执行优化全量 compaction 的频率，该配置用于确保读优化系统表的查询时效性。</li>
<li><code>'full-compaction.delta-commits'</code>：全量 compaction 会在每次增量提交后持续触发。缺点是只能同步执行 compaction，会影响写入效率。</li>
</ol>
<h2 id="lookup-compaction">
  Lookup Compaction
  <a class="anchor" href="#lookup-compaction">#</a>
</h2>
<p>当主键表配置了 <code>lookup</code> <a href="//localhost:1313/primary-key-table/changelog-producer/">changelog producer</a><br>
或 <code>first-row</code> <a href="//localhost:1313/primary-key-table/merge-engine/">merge-engine</a><br>
或启用了用于 <a href="//localhost:1313/primary-key-table/table-mode/#merge-on-write">MOW 模式</a> 的 <code>deletion vectors</code>，<br>
Paimon 会使用激进的 compaction 策略，强制将 level 0 文件压缩到更高层级，每次触发 compaction 都执行此操作。</p>
<p>Paimon 还提供配置来优化此 compaction 的频率：</p>
<ol>
<li><code>'lookup-compact'</code>：lookup compaction 使用的压缩模式。可选值：
<ul>
<li><code>radical</code>：使用 <code>ForceUpLevel0Compaction</code> 策略激进地压缩新文件；</li>
<li><code>gentle</code>：使用 <code>UniversalCompaction</code> 策略温和地压缩新文件；</li>
</ul>
</li>
<li><code>'lookup-compact.max-interval'</code>：在 <code>gentle</code> 模式下，强制触发 L0 lookup compaction 的最大时间间隔。<br>
仅在 <code>'lookup-compact'</code> 设置为 <code>gentle</code> 时有效。</li>
</ol>
<p>将 <code>'lookup-compact'</code> 配置为 <code>gentle</code> 后，L0 新文件不会立即被压缩，<br>
这可能大幅降低整体资源消耗，但在某些情况下会牺牲数据的新鲜度。</p>
<h2 id="compaction-options">
  Compaction Options
  <a class="anchor" href="#compaction-options">#</a>
</h2>
<h3 id="number-of-sorted-runs-to-pause-writing">
  Number of Sorted Runs to Pause Writing
  <a class="anchor" href="#number-of-sorted-runs-to-pause-writing">#</a>
</h3>
<p>当排序运行（sorted runs）的数量较少时，Paimon 写入器会在独立线程中异步执行 compaction，<br>
从而使记录可以持续写入表中。</p>
<p>但是，为了避免排序运行数量无限增长，当排序运行数量达到阈值时，写入器会暂停写入。<br>
该阈值由以下表属性决定。</p>
<table class="table table-bordered">
    <thead>
    <tr>
      <th class="text-left" style="width: 20%">Option</th>
      <th class="text-left" style="width: 5%">Required</th>
      <th class="text-left" style="width: 5%">Default</th>
      <th class="text-left" style="width: 10%">Type</th>
      <th class="text-left" style="width: 60%">Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td><h5>num-sorted-run.stop-trigger</h5></td>
      <td>No</td>
      <td style="word-wrap: break-word;">(none)</td>
      <td>Integer</td>
      <td>T触发写入停止的排序运行（sorted runs）数量，默认值为 `num-sorted-run.compaction-trigger` + 3。.</td>
    </tr>
    </tbody>
</table>
<p>当 <code>num-sorted-run.stop-trigger</code> 设置得较大时，写入阻塞（write stalls）会变得较少，从而提升写入性能。然而，如果该值设置得过大，查询表时将消耗更多的内存和 CPU 时间。如果担心内存溢出（OOM）问题，请配置以下选项。</p>
<p>该值应根据您的内存大小进行调整。</p>
<table class="table table-bordered">
    <thead>
    <tr>
      <th class="text-left" style="width: 20%">Option</th>
      <th class="text-left" style="width: 5%">Required</th>
      <th class="text-left" style="width: 5%">Default</th>
      <th class="text-left" style="width: 10%">Type</th>
      <th class="text-left" style="width: 60%">Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td><h5>sort-spill-threshold</h5></td>
      <td>No</td>
      <td style="word-wrap: break-word;">(none)</td>
      <td>Integer</td>
      <td>如果排序读取器的最大数量超过此值，将尝试进行溢写（spill）。这样可以防止过多的读取器占用过多内存，从而导致内存溢出（OOM）。</td>
    </tr>
    </tbody>
</table>
<h3 id="number-of-sorted-runs-to-trigger-compaction">
  Number of Sorted Runs to Trigger Compaction
  <a class="anchor" href="#number-of-sorted-runs-to-trigger-compaction">#</a>
</h3>
<p>Paimon 使用支持大量更新的 <a href="//localhost:1313/primary-key-table/overview/#lsm-trees">LSM tree</a>。LSM 将文件组织成多个 <a href="//localhost:1313/primary-key-table/overview/#sorted-runs">sorted runs</a>。查询 LSM 树中的记录时，必须合并所有排序运行，才能得到完整的记录视图。</p>
<p>显而易见，过多的排序运行会导致查询性能下降。为了将排序运行数量控制在合理范围内，Paimon 写入器会自动执行 <a href="//localhost:1313/primary-key-table/compaction/">compaction</a>。以下表属性决定触发 compaction 的最小排序运行数量。</p>
<table class="table table-bordered">
    <thead>
    <tr>
      <th class="text-left" style="width: 20%">Option</th>
      <th class="text-left" style="width: 5%">Required</th>
      <th class="text-left" style="width: 5%">Default</th>
      <th class="text-left" style="width: 10%">Type</th>
      <th class="text-left" style="width: 60%">Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td><h5>num-sorted-run.compaction-trigger</h5></td>
      <td>No</td>
      <td style="word-wrap: break-word;">5</td>
      <td>Integer</td>
      <td>触发 compaction 的排序运行（sorted run）数量。包括 level0 文件（每个文件对应一个排序运行）和高层级的排序运行（每个层级对应一个排序运行）。</td>
    </tr>
    </tbody>
</table>
<p>当 <code>num-sorted-run.compaction-trigger</code> 变大时，compaction 发生的频率会降低，从而提升写入性能。但如果该值过大，查询表时将需要更多的内存和 CPU 时间。这是在写入性能和查询性能之间的权衡。</p>
</article>
 
      

      <footer class="book-footer">
        
  




<a href="//github.com/apache/paimon/edit/1.2/docs/content/primary-key-table%5ccompaction.md" style="color:black"><i class="fa fa-edit fa-fw"></i>Edit This Page</a>


 
        


<hr style="margin-top: 20px; border: 1px solid #e5e5e5;" />

<table style="border-spacing: 10px;">
    <tbody>
    <tr>
        <td colspan="2">
            Copyright &copy; 2025 The Apache Software Foundation. Apache Paimon, Paimon, and its feather logo are
            trademarks of The Apache Software Foundation.
        </td>
    </tr>
    </tbody>
</table>

      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  

<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#异步合并-asynchronous-compaction">异步合并 Asynchronous Compaction</a></li>
    <li><a href="#dedicated-compaction-job">Dedicated compaction job</a></li>
    <li><a href="#record-level-expire">Record-Level expire</a></li>
    <li><a href="#full-compaction">Full Compaction</a></li>
    <li><a href="#lookup-compaction">Lookup Compaction</a></li>
    <li><a href="#compaction-options">Compaction Options</a>
      <ul>
        <li><a href="#number-of-sorted-runs-to-pause-writing">Number of Sorted Runs to Pause Writing</a></li>
        <li><a href="#number-of-sorted-runs-to-trigger-compaction">Number of Sorted Runs to Trigger Compaction</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    <aside class="expand-toc">
      <button class="toc" onclick="expandToc()">
        <i class="fa fa-expand" aria-hidden="true"></i>
      </button>
    </aside>
    
  </main>

  
</body>

</html>












